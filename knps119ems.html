<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸš‘ ë¬´ë“±ì‚°ì‚°ì•…ì‚¬ê³  ì‘ê¸‰í™˜ì ê¸°ë¡(ë¬´ë“±ì‚°íŠ¹ìˆ˜ì‚°ì•…êµ¬ì¡°íŒ€/119/ë³‘ì›)</title>
<style>
:root{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR',sans-serif}
body{margin:0;padding:18px;background:#f4f7fb;color:#111}
.container{max-width:1100px;margin:0 auto}
header{display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:20px}
 .card { background: #fff; border-radius: 10px; padding: 30px; margin-top: 15px; box-shadow: 0 6px 18px rgba(20,30,60,.06); }
    label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; }
    input[type=text], input[type=datetime-local], textarea, select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #d7dfe8; }
    textarea { min-height: 80px; }
    .grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 30px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 30px; }
    .row { display: flex; gap: 10px; }
    button { background: #0b5cff; color: #fff; border: none; padding: 9px 12px; border-radius: 8px; cursor: pointer; }
    button.secondary { background: #6c757d; }
    button.small { font-size: 13px; padding: 6px 10px; }
    .muted { color: #666; font-size: 13px; }
.attachments img{max-width:120px;border-radius:6px;margin-right:8px;margin-bottom:8px}
footer{margin-top:14px;font-size:13px;color:#666}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef4ff;color:#0540b6;font-weight:600}
.log{max-height:200px;overflow:auto;padding:8px;background:#fcfcff;border-radius:8px;border:1px solid #eef2ff}
</style>
</head>
<body>
<div class="container">
<header>
  <h1>ë¬´ë“±ì‚°ì‚°ì•…ì‚¬ê³  ì‘ê¸‰í™˜ì ê¸°ë¡</h1>
  <div style="margin-left:auto" class="pill">ë¬´ë“±ì‚°íŠ¹ìˆ˜ì‚°ì•…êµ¬ì¡°íŒ€ â€¢ 119 â€¢ ë³‘ì›</div>
</header>

<section class="card">
  <div class="grid">
    <div>
      <label>ë³´ê³ ì / ê¸°ê´€</label>
      <input id="sender" type="text" placeholder="ì˜ˆ: ë¬´ë“±ì‚°íŠ¹ìˆ˜ì‚°ì•…êµ¬ì¡°íŒ€ / 119 êµ¬ê¸‰ëŒ€" />
    </div>
    <div>
      <label>ìˆ˜ì‹ ëŒ€ìƒ (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label>
      <input id="recipients" type="text" placeholder="ì˜ˆ: 119ë³‘ì›, ì¢…í•©ë³‘ì› ì‘ê¸‰ì‹¤" />
    </div>
  </div>

  <hr style="margin:12px 0;border:none;border-top:1px solid #eef2ff" />

  <label>í™˜ì ê¸°ë³¸ì •ë³´</label>
  <div class="grid-3">
    <div><input id="name" type="text" placeholder="ì´ë¦„" /></div>
    <div><input id="age" type="text" placeholder="ë‚˜ì´" /></div>
    <div>
      <select id="sex">
        <option value="">ì„±ë³„</option>
        <option value="M">ë‚¨</option>
        <option value="F">ì—¬</option>
        <option value="U">ë¶ˆëª…</option>
      </select>
    </div>
  </div>

  <label style="margin-top:8px">í™˜ììƒíƒœ ìš”ì•½ (ìµœëŒ€ 300ì)</label>
  <textarea id="summary" maxlength="300" placeholder="ê°„ë‹¨í•œ ì¦ìƒ/ìƒíƒœ: ì˜ì‹, í˜¸í¡, ì¶œí˜ˆ ë“±"></textarea>

  <div class="grid" style="margin-top:10px">
    <div>
      <label>ì˜ì‹ ìƒíƒœ</label>
      <select id="gcs">
        <option value="">ì„ íƒ</option>
        <option value="alert">ì •ìƒ(ì˜ì‹ëª…ë£Œ)</option>
        <option value="verbal">ì–¸ì–´ë°˜ì‘ë§Œ</option>
        <option value="pain">í†µì¦ë°˜ì‘ë§Œ</option>
        <option value="unresponsive">ë¬´ë°˜ì‘</option>
      </select>
    </div>
    <div>
      <label>ë¶€ìƒ/ì£¼ìš” ë³‘ë ¥</label>
      <input id="hx" type="text" placeholder="ì˜ˆ: ê³ í˜ˆì••, ë‹¹ë‡¨, ì•½ë¬¼ë³µìš© ë“±" />
    </div>
  </div>

  <div style="margin-top:10px" class="grid-3">
    <div>
      <label>í˜¸í¡(íšŒ/ë¶„)</label>
      <input id="rr" type="text" placeholder="RR" />
    </div>
    <div>
      <label>ë§¥ë°•(íšŒ/ë¶„)</label>
      <input id="hr" type="text" placeholder="HR" />
    </div>
    <div>
      <label>í˜ˆì••(mmHg)</label>
      <input id="bp" type="text" placeholder="ì˜ˆ: 120/80" />
    </div>
  </div>

  <div style="margin-top:10px" class="grid">
    <div>
      <label>ì²´ì˜¨(Â°C)</label>
      <input id="temp" type="text" placeholder="ì˜ˆ: 36.7" />
    </div>
    <div>
      <label>ì‚°ì†Œí¬í™”ë„(SpOâ‚‚ %)</label>
      <input id="spo2" type="text" placeholder="ì˜ˆ: 98" />
    </div>
  </div>

  <label style="margin-top:10px">ì‘ê¸‰ì²˜ì¹˜ ê¸°ë¡</label>
  <textarea id="treatment" placeholder="ì˜ˆ: ì‚°ì†Œíˆ¬ì—¬ 10L, ì§€í˜ˆ: ì••ë°•ë¶•ëŒ€"></textarea>

  <div style="margin-top:10px" class="grid">
    <div>
      <label>ë°œìƒ ìœ„ì¹˜ (GPS ìë™/ìˆ˜ë™)</label>
      <input id="location" type="text" placeholder="ìœ„ë„,ê²½ë„ ë˜ëŠ” ìƒì„¸ ìœ„ì¹˜" />
      <div style="margin-top:6px">
        <button id="getGps" class="small secondary">GPS ê°€ì ¸ì˜¤ê¸°</button>
        <span id="gpsStatus" class="muted" style="margin-left:8px"></span>
      </div>
    </div>
    <div>
      <label>ë°œìƒ ì‹œê°„</label>
      <input id="time" type="datetime-local" />
    </div>
  </div>

  <label style="margin-top:10px">ì²¨ë¶€ ì‚¬ì§„ / íŒŒì¼ (ë¸Œë¼ìš°ì € ì„ì‹œ ì €ì¥)</label>
  <input id="file" type="file" multiple />
  <div class="attachments" id="attachments"></div>

  <div style="margin-top:12px;display:flex;gap:8px" id="actionButtons">
    
    <button id="saveLocal" class="secondary">í•¸ë“œí° ì €ì¥</button>
    <button id="printBtn" class="secondary">PDF ì €ì¥</button>
    <button id="sendGoogle" style="background:#28a745;color:#fff">ì •ë³´ ì „ì†¡</button>
  </div>
</section>

<section class="card">
  <label>ì €ì¥ëœ ê¸°ë¡</label>
  <div id="savedList"></div>
</section>

<footer>
* ì´ ë„êµ¬ëŠ” í˜„ì¥ ê°„ë‹¨ì •ë³´ ê³µìœ ìš© í…œí”Œë¦¿ì…ë‹ˆë‹¤. ì‹¤ì œ í™˜ìì •ë³´(ê°œì¸ì •ë³´)ëŠ” ë³´ì•ˆëœ í†µì‹ /ì„œë²„ì™€ ì¸ì¦ì„ í†µí•´ êµí™˜í•´ì•¼ í•©ë‹ˆë‹¤.
</footer>
</div>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvqd6zAsmmQOaJpwJVAiaIdero7MwG3FCPQcwe56ZhobJiSjt2xai6yqbwh5eQH0fu/exec";

/* DOM */
const sender = document.getElementById('sender');
const recipients = document.getElementById('recipients');
const nameEl = document.getElementById('name');
const ageEl = document.getElementById('age');
const sexEl = document.getElementById('sex');
const summary = document.getElementById('summary');
const gcs = document.getElementById('gcs');
const hx = document.getElementById('hx');
const rr = document.getElementById('rr');
const hr = document.getElementById('hr');
const bp = document.getElementById('bp');
const temp = document.getElementById('temp');
const spo2 = document.getElementById('spo2');
const treatment = document.getElementById('treatment');
const locationEl = document.getElementById('location');
const timeEl = document.getElementById('time');
const fileEl = document.getElementById('file');
const attachmentsDiv = document.getElementById('attachments');
const savedList = document.getElementById('savedList');
const gpsStatus = document.getElementById('gpsStatus');

let attachments = [];

/* ------------------ íŒŒì¼ ì—…ë¡œë“œ ------------------ */
fileEl.addEventListener('change', async(e)=>{
  const files = Array.from(e.target.files);
  for(const f of files){
    if(f.size > 5*1024*1024){
      alert(`${f.name} íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (5MB ì´í•˜ë§Œ ê°€ëŠ¥)`);
      continue;
    }
    const dataUrl = await readFileAsDataURL(f);
    attachments.push({name:f.name,dataUrl});
    renderAttachments();
  }
});

function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function renderAttachments(){
  attachmentsDiv.innerHTML = '';
  attachments.forEach((a,idx)=>{
    const wrap = document.createElement('div');
    wrap.style.display = 'inline-block';
    wrap.style.position = 'relative';
    wrap.style.marginRight = '8px';

    if(a.dataUrl.startsWith("data:image")){
      const img = document.createElement('img');
      img.src = a.dataUrl;
      wrap.appendChild(img);
    } else {
      const box = document.createElement('div');
      box.textContent = a.name;
      box.className='muted';
      wrap.appendChild(box);
    }

    const del = document.createElement('button');
    del.textContent="ì‚­ì œ";
    del.className="small secondary";
    del.style.position="absolute";
    del.style.right="0";
    del.style.bottom="0";
    del.onclick = ()=>{ attachments.splice(idx,1); renderAttachments(); };
    wrap.appendChild(del);

    attachmentsDiv.appendChild(wrap);
  });
}

/* ------------------ JSON ìƒì„± ------------------ */
function buildPayload(){
  return {
    meta:{from:sender.value,to:recipients.value,createdAt:new Date().toISOString()},
    patient:{name:nameEl.value,age:ageEl.value,sex:sexEl.value,summary:summary.value,gcs:gcs.value,history:hx.value},
    vitals:{rr:rr.value,hr:hr.value,bp:bp.value,temp:temp.value,spo2:spo2.value},
    treatment:treatment.value,
    location:{text:locationEl.value,time:timeEl.value || new Date().toISOString()},
    attachments:attachments
  };
}

/* ------------------ Google Sheets ì „ì†¡ ------------------ */
function sendToGoogle(){
  const payload = buildPayload();
  fetch(GOOGLE_SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  })
  .then(r=>r.text())
  .then(t=>{
    alert("êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ ì™„ë£Œ");
  })
  .catch(e=>{
    alert("ì „ì†¡ ì˜¤ë¥˜ ë°œìƒ (CORS/ê¶Œí•œ í™•ì¸ í•„ìš”)");
  });
}

/* ------------------ ë²„íŠ¼ ì´ë²¤íŠ¸ ------------------ */
document.getElementById('sendGoogle').onclick = sendToGoogle;
document.getElementById('copyJson').onclick = ()=>{
  navigator.clipboard.writeText(JSON.stringify(buildPayload(),null,2));
  alert("JSON ë³µì‚¬ë¨");
};
document.getElementById('saveLocal').onclick = ()=>{
  const arr = JSON.parse(localStorage.getItem('records')||'[]');
  arr.unshift(buildPayload());
  localStorage.setItem('records',JSON.stringify(arr));
  renderSaved();
  alert("ë¡œì»¬ ì €ì¥ ì™„ë£Œ");
};
document.getElementById('printBtn').onclick = ()=>window.print();

/* ------------------ GPS ------------------ */
document.getElementById('getGps').onclick = ()=>{
  if(!navigator.geolocation){
    gpsStatus.textContent="GPS ì§€ì› ì•ˆë¨";
    return;
  }
  gpsStatus.textContent="ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
  navigator.geolocation.getCurrentPosition(
    pos=>{
      locationEl.value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
      gpsStatus.textContent="GPS ìˆ˜ì‹  ì„±ê³µ";
    },
    err=>{
      switch(err.code){
        case 1: gpsStatus.textContent="GPS ê¶Œí•œ ê±°ë¶€ë¨"; break;
        case 2: gpsStatus.textContent="ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ"; break;
        case 3: gpsStatus.textContent="GPS ìš”ì²­ ì‹œê°„ ì´ˆê³¼"; break;
        default: gpsStatus.textContent="ì•Œ ìˆ˜ ì—†ëŠ” GPS ì˜¤ë¥˜"; break;
      }
    },
    {timeout:10000}
  );
};

/* ------------------ ë¡œì»¬ ê¸°ë¡ ------------------ */
function renderSaved(){
  const arr = JSON.parse(localStorage.getItem('records')||'[]');
  savedList.innerHTML = "";
  arr.slice(0,20).forEach((r,i)=>{
    const d = document.createElement('div');
    d.style.padding = "8px";
    d.style.borderBottom = "1px solid #f1f5f9";
    d.innerHTML = `
      <div style="font-weight:600">
        ${r.patient?.name || 'ë¬´ëª…'}
        <span style="color:#666;font-weight:400"> ${new Date(r.meta?.createdAt).toLocaleString()}</span>
      </div>
      <div class="muted">${r.patient?.summary || ''}</div>
      <button class="small" data-index="${i}" data-action="view">ì—´ê¸°</button>
      <button class="small secondary" data-index="${i}" data-action="delete">ì‚­ì œ</button>
    `;
    savedList.appendChild(d);
  });
  savedList.querySelectorAll('button').forEach(btn=>{
    btn.onclick = ()=> {
      const idx = btn.dataset.index;
      if(btn.dataset.action==='view') viewRecord(idx);
      if(btn.dataset.action==='delete') deleteRecord(idx);
    };
  });
}

function populateForm(obj){
  if(obj.meta){sender.value=obj.meta.from||""; recipients.value=obj.meta.to||""; timeEl.value=obj.location?.time || obj.meta.createdAt || "";}
  if(obj.patient){
    nameEl.value=obj.patient.name||"";
    ageEl.value=obj.patient.age||"";
    sexEl.value=obj.patient.sex||"";
    summary.value=obj.patient.summary||"";
    gcs.value=obj.patient.gcs||"";
    hx.value=obj.patient.history||"";
  }
  if(obj.vitals){
    rr.value=obj.vitals.rr||"";
    hr.value=obj.vitals.hr||"";
    bp.value=obj.vitals.bp||"";
    temp.value=obj.vitals.temp||"";
    spo2.value=obj.vitals.spo2||"";
  }
  treatment.value = obj.treatment||"";
  locationEl.value = obj.location?.text||"";
  attachments = obj.attachments||[];
  renderAttachments();
}

window.viewRecord = function(i){
  const arr = JSON.parse(localStorage.getItem('records')||'[]');
  populateForm(arr[i]);
};

window.deleteRecord = function(i){
  const arr = JSON.parse(localStorage.getItem('records')||'[]');
  arr.splice(i,1);
  localStorage.setItem('records',JSON.stringify(arr));
  renderSaved();
}

/* ------------------ ì´ˆê¸°í™” ------------------ */
renderSaved();
</script>

</body>
</html>
