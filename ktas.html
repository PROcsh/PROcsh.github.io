<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“Œ êµ­ë¦½ê³µì› íŠ¹ìˆ˜êµ¬ì¡°ëŒ€ ì¤‘ì¦ë„ ë¶„ë¥˜ë„êµ¬ (êµìœ¡ìš©)</title>
<style>
  :root{
    --bg:#0b1020; --card:#121933; --muted:#8ea0c6; --fg:#e8eeff;
    --ktas1:#ff3b30; --ktas2:#ff9500; --ktas3:#ffcc00; --ktas4:#34c759; --ktas5:#30b0ff;
    --accent:#7aa2ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1020 100%);color:var(--fg);font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif;line-height:1.35}
  header{position:sticky;top:0;background:rgba(10,15,30,.7);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{margin:8px 0 4px;font-size:22px;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:10px}
  .grid{display:grid;gap:14px}
  @media (min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
  section{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
  section h2{margin:0 0 10px;font-size:15px;color:#bfd0ff;font-weight:700}
  label{display:block;font-size:13px;color:#cbd8ff;margin:8px 0 6px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0d1530;color:var(--fg);font-size:14px}
  input[type="number"]{appearance:textfield}
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);cursor:pointer;user-select:none}
  .chip input{display:none}
  .chip.active{background:#16224a;border-color:#3b5bd6}
  .btns{display:flex;gap:10px;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#152150;color:var(--fg);cursor:pointer;font-weight:600}
  button.primary{background:var(--accent);color:#0a0f1e;border:none}
  button.warn{background:#26314f;border-color:#ff7a7a;color:#ffdede}
  .result{display:flex;flex-direction:column;gap:10px}
  .badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 12px;font-weight:800}
  .k1{background:var(--ktas1)}.k2{background:var(--ktas2)}.k3{background:var(--ktas3);color:#2a2100}
  .k4{background:var(--ktas4);color:#001a05}.k5{background:var(--ktas5);color:#00131d}
  .muted{color:var(--muted);font-size:13px}
  ul{margin:0 0 0 18px}
  .footer{color:#9fb2e6;font-size:12px;margin-top:10px}
  .timebox{display:flex;gap:8px;flex-wrap:wrap}
  .pill{border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;font-size:12px}
  .danger{color:#ff9fa3}
  .ok{color:#aaf0c9}
  .flex{display:flex;gap:12px;flex-wrap:wrap}
  .hint{font-size:12px;color:#9fb2e6}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ğŸ“Œ êµ­ë¦½ê³µì› íŠ¹ìˆ˜êµ¬ì¡°ëŒ€ ì¤‘ì¦ë„ ë¶„ë¥˜ë„êµ¬ <span class="hint">(êµìœ¡/ì‹œë®¬ë ˆì´ì…˜ìš©)</span></h1>
    <div class="sub">ì…ë ¥ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ê·œì¹™ì ìš© â†’ í™˜ììƒíƒœ 1~5 ì‚°ì¶œ Â· ê·¼ê±° í‘œì‹œ Â· ì¸ì‡„/JSON ì €ì¥</div>
  </div>
</header>

<main class="wrap grid grid-2">
  <!-- í™˜ì/ë„ì°© ì •ë³´ -->
  <section>
    <h2>â‘  í™˜ì ê¸°ë³¸ì •ë³´</h2>
    <div class="row-2">
      <div>
        <label>ì´ë¦„</label>
        <input id="ptName" placeholder="" />
      </div>
      <div>
        <label>ì„±ë³„</label>
        <select id="ptSex">
          <option>ì„ íƒ</option><option>ë‚¨</option><option>ì—¬</option><option>ê¸°íƒ€/ë¯¸ìƒ</option>
        </select>
      </div>
    </div>
    <div class="row-4" style="margin-top:8px">
      <div>
        <label>ë‚˜ì´(ë…„)</label>
        <input id="ptAge" type="number" min="0" step="1" placeholder="" />
      </div>
      <div>
        <label>ì²´ì¤‘(kg)</label>
        <input id="ptWt" type="number" min="0" step="0.1" placeholder="" />
      </div>
     <div class="col">
  <label>ë„ì°©ì¼ì‹œ</label>
  <input id="arrTime" type="datetime-local">
</div>
      <div>
        <label>ë‚´ì›ê²½ë¡œ</label>
        <select id="arrival">
          <option>ì„ íƒ</option>
          <option>êµ¬ê¸‰ëŒ€ ì´ì†¡</option><option>ìê°€</option><option>íƒ€ë³‘ì›ì „ì›</option><option>ê¸°íƒ€</option>
        </select>
      </div>
    </div>
  </section>

  <!-- í™œë ¥ì§•í›„ -->
  <section>
    <h2>â‘¡ í™œë ¥ì§•í›„ / ì˜ì‹</h2>
    <div class="row-4">
      <div><label>í˜¸í¡ìˆ˜(RR)</label><input id="rr" type="number" min="0" max="300" placeholder=""></div>
      <div><label>ì‚°ì†Œí¬í™”ë„(SpOâ‚‚%)</label><input id="spo2" type="number" min="0" max="100" placeholder=""></div>
      <div><label>ì‹¬ë°•ìˆ˜(HR)</label><input id="hr" type="number" min="0" placeholder=""></div>
      <div><label>ìˆ˜ì¶•ê¸°í˜ˆì••(SBP)</label><input id="sbp" type="number" min="0" placeholder=""></div>
    </div>
    <div class="row-4" style="margin-top:8px">
      <div><label>ì²´ì˜¨(â„ƒ)</label><input id="temp" type="number" step="0.1" placeholder=""></div>
      <div><label>AVPU</label>
        <select id="avpu"><option value="ì„ íƒ">ì„ íƒ</option><option value="A">A</option><option value="V">V</option><option value="P">P</option><option value="U">U</option></select>
      </div>
      <div><label>GCS í•©ê³„</label><input id="gcs" type="number" min="3" max="15" placeholder=""></div>
      <div><label>í†µì¦ NRS(0-10)</label><input id="pain" type="number" min="0" max="10" placeholder=""></div>
    </div>
  </section>

  <!-- ì¦‰ì‹œ ìƒëª…ìœ„í˜‘ -->
  <section>
    <h2>â‘¢ ì¦‰ì‹œ ìœ„í˜‘(ìˆìœ¼ë©´ í™˜ììƒíƒœ 1)</h2>
    <div class="chips" id="redFlags">
      <!-- ì²´í¬ í† ê¸€ -->
      <label class="chip"><input type="checkbox" value="ë¬´í˜¸í¡/ê¸°ë„íì‡„"><span>ë¬´í˜¸í¡/ê¸°ë„íì‡„</span></label>
      <label class="chip"><input type="checkbox" value="ë¬´ë§¥/ì‹¬ì •ì§€"><span>ë¬´ë§¥/ì‹¬ì •ì§€</span></label>
      <label class="chip"><input type="checkbox" value="ë°˜ì‘ì—†ìŒ(U)"><span>ë°˜ì‘ì—†ìŒ(U)</span></label>
      <label class="chip"><input type="checkbox" value="ì§€ì† ê²½ë ¨"><span>ì§€ì† ê²½ë ¨</span></label>
      <label class="chip"><input type="checkbox" value="ì‹¬í•œ í˜¸í¡ê³¤ë€/ì²­ìƒ‰ì¦"><span>ì‹¬í•œ í˜¸í¡ê³¤ë€/ì²­ìƒ‰ì¦</span></label>
      <label class="chip"><input type="checkbox" value="ëŒ€ëŸ‰ì¶œí˜ˆ/ì ˆë‹¨"><span>ëŒ€ëŸ‰ì¶œí˜ˆ/ì ˆë‹¨</span></label>
      <label class="chip"><input type="checkbox" value="ì‡¼í¬ ì˜ì‹¬"><span>ì‡¼í¬ ì˜ì‹¬</span></label>
      <label class="chip"><input type="checkbox" value="ê´‘ë²”ìœ„ í™”ìƒ/í¡ì¸"><span>ê´‘ë²”ìœ„ í™”ìƒ/í¡ì¸</span></label>
      <label class="chip"><input type="checkbox" value="ë‹¤ë°œì„± ê³ ì—ë„ˆì§€ ì™¸ìƒ"><span>ë‹¤ë°œì„± ê³ ì—ë„ˆì§€ ì™¸ìƒ</span></label>
    </div>
  </section>

  <!-- ì¦ìƒêµ° -->
  <section>
    <h2>â‘£ ì£¼ì¦ìƒ(Chief Complaint)</h2>
    <div class="row-2">
      <div>
        <label>ì¦ìƒêµ°</label>
        <select id="cc">
          <option>ì„ íƒ</option>
          <option>í˜¸í¡ê³¤ë€</option><option>í‰í†µ</option><option>ë³µí†µ</option><option>ë°œì—´</option>
          <option>ì‹ ê²½í•™ì /ì˜ì‹ë³€í™”</option><option>ì™¸ìƒ-ë¨¸ë¦¬</option><option>ì™¸ìƒ-í‰ë³µë¶€/ê³¨ë°˜</option>
          <option>ì™¸ìƒ-ì‚¬ì§€/ì—°ë¶€</option><option>í™”ìƒ</option><option>ì¤‘ë…/ì•½ë¬¼</option>
          <option>ì •ì‹ ê³¼</option><option>ì‚°ë¶€ì¸ê³¼</option><option>ì†Œì•„ ë°œì—´</option><option>ê¸°íƒ€</option>
        </select>
      </div>
      <div>
        <label>ì¦ìƒ ì‹œì‘/ê²½ê³¼</label>
        <input id="onset" placeholder="ì˜ˆ: 2ì‹œê°„ ì „ ë°œìƒ, ì ì  ì•…í™”" />
      </div>
    </div>
    <label style="margin-top:8px">ë³´ì¡° ìˆ˜ì •ì§€í‘œ</label>
    <div class="row-4">
      <div>
        <label>ì¶œí˜ˆ</label>
        <select id="bleed">
          <option value="">ì„ íƒ</option>
          <option value="">ì¶œí˜ˆ ì •ë„ ì„ íƒ</option>
          <option value="severe">í™œë™ì„± ëŒ€ëŸ‰ì¶œí˜ˆ</option>
          <option value="moderate">ì¤‘ë“±ë„ ì¶œí˜ˆ</option>
          <option value="minor">ê²½ë¯¸</option>
        </select>
      </div>
      <div>
        <label>ì†ìƒê¸°ì „</label>
        <select id="mech">
          <option value="">ì„ íƒ</option>
          <option value="">ì†ìƒ ê¸°ì „</option>
          <option value="high">ê³ ì—ë„ˆì§€(ê³ ì†ì¶©ëŒ/ì¶”ë½&gt;5m ë“±)</option>
          <option value="mid">ì¤‘ë“±ë„</option>
          <option value="low">ì €ì—ë„ˆì§€/ë‹¨ìˆœ</option>
        </select>
      </div>
      <div>
        <label>íƒˆìˆ˜/ìˆœí™˜</label>
        <select id="dehyd">
          <option value="">ì„ íƒ</option>
          <option value="">íƒˆìˆ˜/ìˆœí™˜</option>
          <option value="severe">ì¤‘ì¦ íƒˆìˆ˜/ëƒ‰ê° ì°½ë°±/ì§€ì—° CRT</option>
          <option value="moderate">ì¤‘ë“±ë„</option>
          <option value="mild">ê²½ë¯¸</option>
        </select>
      </div>
      <div>
        <label>ì†Œì•„/ë°œì—´</label>
        <select id="feverChild">
          <option value="">ì„ íƒ</option>
          <option value="">ì†Œì•„ ë°œì—´ ë³´ì •</option>
          <option value="lt3m">3ê°œì›” ë¯¸ë§Œ ë°œì—´(â‰¥38â„ƒ)</option>
          <option value="immu">ë©´ì—­ì €í•˜/ì¤‘ì¦ì§ˆí™˜ ì˜ì‹¬</option>
        </select>
      </div>
    </div>
  </section>

  <!-- ê²°ê³¼ -->
  <section>
    <h2>â‘¤ ë¶„ë¥˜ ê²°ê³¼</h2>
    <div class="result" id="resultBox">
      <div id="badge" class="badge k5">í™˜ììƒíƒœ 5 (ë¹„ì‘ê¸‰)</div>
      <div class="timebox">
        <div class="pill">ëª©í‘œ ì§„ë£Œ ëŒ€ê¸°: <span id="target">â‰¤ 120ë¶„</span></div>
        <div class="pill">ì¦ìƒêµ°: <span id="ccOut">-</span></div>
        <div class="pill">ë„ì°©: <span id="timeOut">-</span></div>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">ê·¼ê±°(íŠ¸ë¦¬ê±°):</div>
        <ul id="rationale"></ul>
      </div>
      <div class="footer">
        â€» ë³¸ ë„êµ¬ëŠ” êµìœ¡Â·í›ˆë ¨ ë° ì‹œë®¬ë ˆì´ì…˜ ëª©ì ì…ë‹ˆë‹¤. ì‹¤ì œ ì§„ë£Œ ì‹œ ê¸°ê´€ í”„ë¡œí† ì½œ/ê³µì‹ í™˜ììƒíƒœ ë§¤ë‰´ì–¼ì„ ìš°ì„  ì ìš©í•˜ì„¸ìš”.
      </div>
    </div>
    <div class="btns" style="margin-top:12px">
      <button class="primary" id="calcBtn">ì¤‘ì¦ë„ ì‚°ì¶œ</button>
      <button id="resetBtn">ì…ë ¥ ì´ˆê¸°í™”</button>
      <button id="saveBtn">JSON ì €ì¥</button>
      <button class="warn" id="printBtn">ì¸ì‡„/PDF</button>
      <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
      <button id="saveExcelBtn">ğŸ’¾ ì—‘ì…€ë¡œ ì €ì¥</button>
     </div>
  </section>

  <!-- ë©”ëª¨ -->
  <section>
    <h2>ë©”ëª¨</h2>
    <textarea id="notes" rows="6" placeholder="ê´€ì°°/ì¤‘ì¬/ì‘ê¸‰ì²˜ì¹˜ ë“± ê¸°ë¡"></textarea>
  </section>
</main>

<script>
/* ------------------------------------------
   ìœ í‹¸: ì„ íƒì, ì´ˆê¸°ê°’ ì„¸íŒ…
-------------------------------------------*/
const $ = (q) => document.querySelector(q);
const $$ = (q) => Array.from(document.querySelectorAll(q));

// arrTime ì´ˆê¸°ê°’ (ë¡œì»¬ íƒ€ì„ì¡´ ë°˜ì˜)
(function setInitialArrTime() {
  const el = $("#arrTime");
  if (!el) return;
  const now = new Date();
  const tzOffset = now.getTimezoneOffset() * 60000;
  const localISO = new Date(now - tzOffset).toISOString().slice(0, 16);
  el.value = localISO;
})();

/* ------------------------------------------
   UI: chip í† ê¸€
-------------------------------------------*/
const redFlagsContainer = document.getElementById('redFlags');
if (redFlagsContainer) {
  redFlagsContainer.addEventListener("click", (e) => {
    const chipLabel = e.target.closest(".chip");
    if (!chipLabel) return;
    const checkbox = chipLabel.querySelector("input[type=checkbox]");
    if (checkbox) {
      // Toggle the checkbox state
      checkbox.checked = !checkbox.checked;
      // Update the active class based on the new checkbox state
      if (checkbox.checked) {
        chipLabel.classList.add("active");
      } else {
        chipLabel.classList.remove("active");
      }
    }
  });
}

/* ------------------------------------------
   ì¤‘ì¦ë„ ê³„ì‚° ë¡œì§ (ì›ë³¸ ìœ ì§€)
-------------------------------------------*/
function setBadge(level) {
  const badge = $("#badge");
  badge.className = "badge k" + level;
  const labels = {
    1: "í™˜ììƒíƒœ 1 (ìµœì¤‘ì¦Â·ì¦‰ì‹œ)",
    2: "í™˜ììƒíƒœ 2 (ì‘ê¸‰Â·15ë¶„)",
    3: "í™˜ììƒíƒœ 3 (ì¤€ì‘ê¸‰Â·30ë¶„)",
    4: "í™˜ììƒíƒœ 4 (ê²½ì¦Â·60ë¶„)",
    5: "í™˜ììƒíƒœ 5 (ë¹„ì‘ê¸‰Â·120ë¶„)"
  };
  badge.textContent = labels[level];
  $("#target").textContent = ({
    1: "ì¦‰ì‹œ",
    2: "â‰¤ 15ë¶„",
    3: "â‰¤ 30ë¶„",
    4: "â‰¤ 60ë¶„",
    5: "â‰¤ 120ë¶„"
  })[level];
}

function pushReason(reasons, text, minLevel) {
  reasons.push("[" + (minLevel === 1 ? "Critical" : minLevel === 2 ? "High" : minLevel === 3 ? "Moderate" : minLevel === 4 ? "Low" : "Info") + "] " + text);
}

function computeLevel() {
  const reasons = [];
  let level = 5; // ë‚®ì„ìˆ˜ë¡ ìœ„ì¤‘

  const age = +($("#ptAge").value||0);
  const rr = +($("#rr").value||0);
  const spo2 = +($("#spo2").value||0);
  const hr = +($("#hr").value||0);
  const sbp = +($("#sbp").value||0);
  const temp = +($("#temp").value||0);
  const avpu = $("#avpu").value;
  const gcs = +($("#gcs").value||15);
  const pain = +($("#pain").value||0);

  const bleed = $("#bleed").value;
  const mech = $("#mech").value;
  const dehyd = $("#dehyd").value;
  const feverChild = $("#feverChild").value;
  const cc = $("#cc").value;

  // 1) ì¦‰ì‹œ ìœ„í˜‘
  const redFlags = $$("#redFlags input:checked").map(i=>i.value);
  if (redFlags.length>0 || avpu==="U" || gcs<=8){
    pushReason(reasons, "ì¦‰ì‹œ ìƒëª…ìœ„í˜‘/ë°˜ì‘ì—†ìŒ/ì¤‘ì¦ì˜ì‹ì €í•˜", 1);
    return {level:1, reasons};
  }

  // 2) í˜¸í¡/ì‚°ì†Œí™”
  if ((rr>30 && rr<300) || (rr>0 && rr<8)){
    level = Math.min(level, 2);
    pushReason(reasons, "í˜¸í¡ìˆ˜ RR >30 ë˜ëŠ” <8", 2);
  } else if (rr>=24){
    level = Math.min(level, 3);
    pushReason(reasons, "í˜¸í¡ìˆ˜ RR 24~30", 3);
  }

  if (spo2 && spo2<90){
    level = Math.min(level, 2);
    pushReason(reasons, "SpOâ‚‚ < 90%", 2);
  } else if (spo2 && spo2>=90 && spo2<=92){
    level = Math.min(level, 3);
    pushReason(reasons, "SpOâ‚‚ 90~92%", 3);
  }

  // 3) ìˆœí™˜
  if (sbp && sbp<90){
    level = Math.min(level, 2);
    pushReason(reasons, "SBP < 90 mmHg", 2);
  } else if (sbp && sbp<=100){
    level = Math.min(level, 3);
    pushReason(reasons, "SBP 90~100 mmHg", 3);
  }

  if (hr && hr>=130){
    level = Math.min(level, 2);
    pushReason(reasons, "HR â‰¥130", 2);
  } else if (hr && hr>=110){
    level = Math.min(level, 3);
    pushReason(reasons, "HR 110~129", 3);
  }

  // 4) ì²´ì˜¨/ì—°ë ¹ ë³´ì •
  if (temp){
    if (temp>=41 || temp<35){
      level = Math.min(level, 2);
      pushReason(reasons, "ê³ ì—´(â‰¥41â„ƒ) ë˜ëŠ” ì €ì²´ì˜¨(<35â„ƒ)", 2);
    }
    if (age>0 && age<0.25 && temp>=38.0){ // 3ê°œì›” ë¯¸ë§Œ
      level = Math.min(level, 2);
      pushReason(reasons, "3ê°œì›” ë¯¸ë§Œ ë°œì—´ â‰¥38.0â„ƒ", 2);
    }
  }
  if (feverChild==="lt3m"){
    level = Math.min(level, 2);
    pushReason(reasons, "ì†Œì•„ ë°œì—´ ë³´ì •: 3ê°œì›” ë¯¸ë§Œ", 2);
  }
  if (feverChild==="immu"){
    level = Math.min(level, 2);
    pushReason(reasons, "ë©´ì—­ì €í•˜/ì¤‘ì¦ ê°ì—¼ ì˜ì‹¬", 2);
  }

  // 5) í†µì¦ ë³´ì • (NRS)
  if (pain>=8){
    level = Math.min(level, 2);
    pushReason(reasons, "ê·¹ì‹¬í•œ í†µì¦(NRS 8~10)", 2);
  } else if (pain>=4){
    level = Math.min(level, 3);
    pushReason(reasons, "ì¤‘ë“±ë„ í†µì¦(NRS 4~7)", 3);
  } else if (pain>=1){
    level = Math.min(level, 4);
    pushReason(reasons, "ê²½ë¯¸í•œ í†µì¦(NRS 1~3)", 4);
  }

  // 6) ì¶œí˜ˆ/ì†ìƒê¸°ì „/íƒˆìˆ˜
  if (bleed==="severe"){
    level = Math.min(level, 2);
    pushReason(reasons, "í™œë™ì„± ëŒ€ëŸ‰ ì¶œí˜ˆ", 2);
  } else if (bleed==="moderate"){
    level = Math.min(level, 3);
    pushReason(reasons, "ì¤‘ë“±ë„ ì¶œí˜ˆ", 3);
  } else if (bleed==="minor"){
    level = Math.min(level, 4);
    pushReason(reasons, "ê²½ë¯¸í•œ ì¶œí˜ˆ", 4);
  }

  if (mech==="high"){
    level = Math.min(level, 2);
    pushReason(reasons, "ê³ ì—ë„ˆì§€ ì†ìƒ ê¸°ì „", 2);
  } else if (mech==="mid"){
    level = Math.min(level, 3);
    pushReason(reasons, "ì¤‘ë“±ë„ ì†ìƒ ê¸°ì „", 3);
  }

  if (dehyd==="severe"){
    level = Math.min(level, 2);
    pushReason(reasons, "ì¤‘ì¦ íƒˆìˆ˜/ë§ì´ˆìˆœí™˜ ì €í•˜", 2);
  } else if (dehyd==="moderate"){
    level = Math.min(level, 3);
    pushReason(reasons, "ì¤‘ë“±ë„ íƒˆìˆ˜", 3);
  }

  // 7) ì¦ìƒêµ°ë³„ ìµœì†Œ ë ˆë²¨ íŒíŠ¸
  const ccMinLevel = {
    "í˜¸í¡ê³¤ë€": 2,
    "í‰í†µ": 3,
    "ë³µí†µ": 4,
    "ë°œì—´": 4,
    "ì‹ ê²½í•™ì /ì˜ì‹ë³€í™”": 2,
    "ì™¸ìƒ-ë¨¸ë¦¬": 3,
    "ì™¸ìƒ-í‰ë³µë¶€/ê³¨ë°˜": 2,
    "ì™¸ìƒ-ì‚¬ì§€/ì—°ë¶€": 4,
    "í™”ìƒ": 3,
    "ì¤‘ë…/ì•½ë¬¼": 3,
    "ì •ì‹ ê³¼": 4,
    "ì‚°ë¶€ì¸ê³¼": 3,
    "ì†Œì•„ ë°œì—´": 4,
    "ê¸°íƒ€": 5
  };
  if (ccMinLevel[cc]){
    level = Math.min(level, ccMinLevel[cc]);
    pushReason(reasons, `ì¦ìƒêµ° ìµœì†Œ ì¤‘ì¦ë„: ${cc} â†’ í™˜ììƒíƒœ â‰¥ ${ccMinLevel[cc]}`, ccMinLevel[cc]);
  }

  // ì˜ì‹ V/PëŠ” ìµœì†Œ 2~3 ë³´ì •
  if (avpu==="P"){
    level = Math.min(level, 2);
    pushReason(reasons, "AVPU = P (í†µì¦ì—ë§Œ ë°˜ì‘)", 2);
  } else if (avpu==="V"){
    level = Math.min(level, 3);
    pushReason(reasons, "AVPU = V (ìŒì„±ìê·¹ ë°˜ì‘)", 3);
  }
  if (gcs && gcs<=12){
    level = Math.min(level, 3);
    pushReason(reasons, "GCS â‰¤ 12", 3);
  }

  return {level, reasons};
}

/* ------------------------------------------
   ë Œë”/ì´ë²¤íŠ¸
-------------------------------------------*/
function render(){
  const {level, reasons} = computeLevel();
  setBadge(level);
  $("#ccOut").textContent = $("#cc").value || "-";
  const arr = $("#arrTime").value || "-";
  $("#timeOut").textContent = arr.replace ? arr.replace("T"," ") : arr;
  const ul = $("#rationale");
  ul.innerHTML = "";
  if (reasons.length===0){
    const li = document.createElement("li");
    li.textContent = "íŠ¹ì´ íŠ¸ë¦¬ê±° ì—†ìŒ â†’ ê¸°ë³¸ í™˜ììƒíƒœ 5 ìœ ì§€";
    ul.appendChild(li);
  } else {
    reasons.forEach(r=>{
      const li = document.createElement("li"); li.textContent = r; ul.appendChild(li);
    });
  }
}

$("#calcBtn").addEventListener("click", render);

$("#resetBtn").addEventListener("click", ()=>{
  document.querySelectorAll("input, select, textarea").forEach(el=>{
    if (el.type==="checkbox") el.checked=false;
    else if (el.type==="datetime-local") {
      const now = new Date(); const tzOffset = now.getTimezoneOffset()*60000;
      el.value = new Date(now - tzOffset).toISOString().slice(0,16);
    }
    else el.value="";
  });
  $$("#redFlags .chip").forEach(c=>c.classList.remove("active"));
  setBadge(5);
  $("#rationale").innerHTML="";
  $("#ccOut").textContent="-"; $("#timeOut").textContent="-";
});

$("#saveBtn").addEventListener("click", ()=>{
  const data = {
    patient:{
      name: $("#ptName").value, sex: $("#ptSex").value, age: $("#ptAge").value, weight: $("#ptWt").value
    },
    arrival: {time: $("#arrTime").value, route: $("#arrival").value},
    vitals:{
      rr: $("#rr").value, spo2: $("#spo2").value, hr: $("#hr").value, sbp: $("#sbp").value, temp: $("#temp").value,
      avpu: $("#avpu").value, gcs: $("#gcs").value, pain: $("#pain").value
    },
    flags: $$("#redFlags input:checked").map(i=>i.value),
    complaint: {cc: $("#cc").value, onset: $("#onset").value, bleed: $("#bleed").value, mech: $("#mech").value, dehyd: $("#dehyd").value, feverChild: $("#feverChild").value},
    notes: $("#notes").value
  };
  const comp = computeLevel();
  data.result = comp;
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  const ts = new Date().toISOString().replace(/[:.]/g,"-").slice(0,19);
  a.download = `KTAS_${ts}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
});

$("#printBtn").addEventListener("click", ()=>window.print());

// ctrl/cmd + Enter ë¡œë„ ê³„ì‚°
document.addEventListener("keydown", (e)=>{
  if (e.key==="Enter" && (e.metaKey || e.ctrlKey)) render();
});

// ì´ˆê¸° ë°°ì§€
setBadge(5);

/* ------------------------------------------
   ì›ê²© ì €ì¥ (ë‚ ì§œë³„ ëˆ„ì  ì €ì¥)
   - WORKER_URL ì„ Cloudflare Worker ë“±ìœ¼ë¡œ ë°°í¬í•œ ì—”ë“œí¬ì¸íŠ¸ë¡œ êµì²´í•˜ì„¸ìš”.
   - WorkerëŠ” { date, result } í˜•íƒœì˜ POSTë¥¼ ë°›ì•„ GitHub APIë¡œ ëˆ„ì  ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
-------------------------------------------*/
const WORKER_URL = "https://your-worker-id.workers.dev"; // <-- ë°°í¬í•œ Worker URLë¡œ ë°”ê¾¸ì„¸ìš”

async function saveResult(){
  // ê³„ì‚° ë¨¼ì € (ë Œë” í¬í•¨)
  const comp = computeLevel();
  render();

  // ì €ì¥í•  ë°ì´í„° êµ¬ì„± (ê¸°ì¡´ ë¡œì»¬ JSONê³¼ ë™ì¼í•œ êµ¬ì¡°)
  const data = {
    patient:{
      name: $("#ptName").value, sex: $("#ptSex").value, age: $("#ptAge").value, weight: $("#ptWt").value
    },
    arrival: {time: $("#arrTime").value, route: $("#arrival").value},
    vitals:{
      rr: $("#rr").value, spo2: $("#spo2").value, hr: $("#hr").value, sbp: $("#sbp").value, temp: $("#temp").value,
      avpu: $("#avpu").value, gcs: $("#gcs").value, pain: $("#pain").value
    },
    flags: $$("#redFlags input:checked").map(i=>i.value),
    complaint: {cc: $("#cc").value, onset: $("#onset").value, bleed: $("#bleed").value, mech: $("#mech").value, dehyd: $("#dehyd").value, feverChild: $("#feverChild").value},
    notes: $("#notes").value,
    result: comp
  };

  const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD

  try {
    const resp = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ date: today, result: data })
    });

    const text = await resp.text();
    if (resp.ok) {
      alert("âœ… ì €ì¥ ì„±ê³µ: GitHubì— ì˜¤ëŠ˜ì íŒŒì¼ì— ëˆ„ì ë˜ì—ˆìŠµë‹ˆë‹¤.");
      console.log("Worker response:", text);
    } else {
      alert("âš ï¸ ì €ì¥ ì‹¤íŒ¨: " + text);
      console.error("Worker error:", text);
    }
  } catch (err) {
    alert("ğŸš¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    console.error(err);
  }
}

 //ì—‘ì…€ ì €ì¥ 
$("#saveExcelBtn").addEventListener("click", ()=>{
  const comp = computeLevel();
  render();

  // ì—‘ì…€ì— ë„£ì„ ë°ì´í„° êµ¬ì„±
  const data = [
    ["í™˜ìëª…", $("#ptName").value],
    ["ì„±ë³„", $("#ptSex").value],
    ["ë‚˜ì´", $("#ptAge").value],
    ["ì²´ì¤‘", $("#ptWt").value],
    ["ë„ì°©ì‹œê°„", $("#arrTime").value],
    ["ì´ì†¡ê²½ë¡œ", $("#arrival").value],
    ["RR", $("#rr").value],
    ["SpO2", $("#spo2").value],
    ["HR", $("#hr").value],
    ["SBP", $("#sbp").value],
    ["ì²´ì˜¨", $("#temp").value],
    ["AVPU", $("#avpu").value],
    ["GCS", $("#gcs").value],
    ["í†µì¦(NRS)", $("#pain").value],
    ["ì£¼ì¦ìƒ", $("#cc").value],
    ["ì¶œí˜ˆ", $("#bleed").value],
    ["ì†ìƒê¸°ì „", $("#mech").value],
    ["íƒˆìˆ˜", $("#dehyd").value],
    ["ì†Œì•„ë°œì—´/ë©´ì—­", $("#feverChild").value],
    ["RedFlags", $$("#redFlags input:checked").map(i=>i.value).join(", ")],
    ["ë©”ëª¨", $("#notes").value],
    ["ìµœì¢… í™˜ììƒíƒœ", comp.level],
    ["ì‚¬ìœ ", comp.reasons.join(" / ")]
  ];

  // SheetJSë¡œ ì›Œí¬ë¶ ìƒì„±
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "KTAS");

  // ì €ì¥ (ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ)
  const ts = new Date().toISOString().replace(/[:.]/g,"-").slice(0,19);
  XLSX.writeFile(wb, `KTAS_${ts}.xlsx`);
});
  
</script>
</body>
</html>
